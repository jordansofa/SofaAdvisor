<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sofa Advisor ‚Äî Jordan</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Mono:wght@400;500&family=Sora:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0f0f10;--surface:#191920;--surface2:#21212b;--surface3:#2b2b38;
      --border:rgba(255,255,255,0.07);--border-hi:rgba(255,255,255,0.13);
      --gold:#f5b944;--gold-dim:rgba(245,185,68,0.14);--gold-glow:rgba(245,185,68,0.25);
      --green:#48c78e;--green-dim:rgba(72,199,142,0.13);
      --blue:#6c8ef5;--red:#f87171;
      --text:#e8e8f0;--text-muted:#7a7a94;--text-faint:#3d3d52;
      --r:12px;--r-sm:8px
    }
    html,body{height:100%;min-height:100%}
    body{font-family:'Sora',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;line-height:1.5}

```
.bg-glow{position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse 70% 50% at 10% 0%,rgba(245,185,68,0.06) 0%,transparent 55%),
             radial-gradient(ellipse 50% 40% at 95% 100%,rgba(72,199,142,0.05) 0%,transparent 50%)}

.app-wrap{position:relative;z-index:1;max-width:1180px;margin:0 auto;padding:28px 18px 70px}

header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:32px}
.header-left{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap}
.header-title{font-family:'DM Serif Display',Georgia,serif;font-size:clamp(24px,5vw,36px);color:var(--text);letter-spacing:-0.4px}
.header-badge{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);background:var(--gold-dim);border:1px solid rgba(245,185,68,0.28);padding:4px 11px;border-radius:100px}
.header-actions{display:flex;gap:8px;flex-wrap:wrap}

.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--r-sm);font-family:'Sora',system-ui,sans-serif;font-size:13px;font-weight:500;cursor:pointer;border:1px solid transparent;transition:background .15s,transform .15s,box-shadow .15s,color .15s;white-space:nowrap}
.btn-ghost{background:var(--surface2);color:var(--text-muted);border-color:var(--border-hi)}
.btn-ghost:hover{background:var(--surface3);color:var(--text)}
.btn-primary{background:var(--gold);color:#0f0f10;font-weight:600}
.btn-primary:hover{background:#f9c95a;transform:translateY(-1px);box-shadow:0 4px 18px var(--gold-glow)}
.btn-success{background:var(--green);color:#0f0f10;font-weight:600}
.btn-success:hover{background:#5dd8a2;transform:translateY(-1px);box-shadow:0 4px 18px rgba(72,199,142,0.35)}
.btn-danger{background:var(--red);color:#0f0f10;font-weight:600;font-size:12px;padding:7px 14px}
.btn-danger:hover{opacity:.85}
.full-width{width:100%;justify-content:center}

.grid-main{display:grid;grid-template-columns:1fr;gap:20px;align-items:start}
@media(min-width:900px){.grid-main{grid-template-columns:320px 1fr}}

.card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:26px}
.section-title{font-family:'DM Serif Display',Georgia,serif;font-size:18px;color:var(--gold);margin-bottom:16px}
.divider{height:1px;background:var(--border);margin:18px 0}

/* FILTERS */
.filter-group{margin-bottom:22px}
.filter-group:last-child{margin-bottom:0}
.filter-group h3{font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);margin-bottom:10px;opacity:.8}
.filter-option{display:flex;align-items:center;gap:10px;padding:7px 0;font-size:13.5px;cursor:pointer;transition:color .1s}
.filter-option:hover{color:var(--gold)}
.filter-option input{accent-color:var(--gold);width:16px;height:16px;cursor:pointer}
.filter-status{font-size:12px;color:var(--text-muted);margin-top:16px;text-align:center;padding:10px;background:var(--surface2);border-radius:var(--r-sm)}

/* CHAT COL */
.chat-col{position:sticky;top:20px}
.chat-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;height:calc(100vh - 160px);min-height:500px;display:flex;flex-direction:column;overflow:hidden}

.chat-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border);background:var(--surface2)}
.chat-header-label{font-size:13px;font-weight:600;color:var(--text-muted);letter-spacing:.5px}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

.chat-body{flex:1;padding:22px;overflow-y:auto;display:flex;flex-direction:column;gap:16px}
.chat-body::-webkit-scrollbar{width:4px}
.chat-body::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px}

.message{display:flex;gap:12px;align-items:flex-start;max-width:88%}
.message.bot{align-self:flex-start}
.message.user{align-self:flex-end;flex-direction:row-reverse}
.avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.message.bot .avatar{background:var(--gold);color:#0f0f10}
.message.user .avatar{background:var(--green);color:#0f0f10;font-size:13px;font-weight:700}
.bubble{background:var(--surface2);padding:13px 17px;border-radius:16px;border-top-left-radius:4px;line-height:1.6;font-size:13.5px}
.bubble p{margin:0 0 8px}
.bubble p:last-child{margin:0}
.bubble ul{margin:8px 0 8px 18px}
.bubble li{margin:4px 0}
.message.user .bubble{background:var(--gold);color:#0f0f10;border-top-left-radius:16px;border-top-right-radius:4px}

.mini-product{background:var(--surface3);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin:8px 0;cursor:pointer;transition:transform .15s,border-color .15s}
.mini-product:hover{transform:translateY(-2px);border-color:var(--gold)}
.mini-product:first-of-type{margin-top:12px}
.mini-product strong{color:var(--gold);display:block;margin-bottom:2px}
.mini-product .price{color:var(--green);font-size:13px;margin:2px 0}
.mini-product small{color:var(--text-muted);font-size:12px;line-height:1.4}

.typing-indicator{display:flex;gap:5px;align-items:center;padding:4px 0}
.typing-indicator span{width:7px;height:7px;border-radius:50%;background:var(--text-muted);animation:typing 1.2s ease infinite}
.typing-indicator span:nth-child(2){animation-delay:.2s}
.typing-indicator span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}

.chat-input-area{display:flex;gap:10px;padding:16px 20px;background:var(--surface2);border-top:1px solid var(--border)}
.chat-input{flex:1;background:var(--surface3);border:1px solid var(--border-hi);border-radius:var(--r-sm);color:var(--text);font-family:'DM Mono',monospace;font-size:13.5px;padding:12px 15px;outline:none;transition:border-color .15s,box-shadow .15s}
.chat-input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(245,185,68,0.1)}
.chat-input::placeholder{color:var(--text-faint)}

/* MODALS */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-inner{background:var(--surface);border:1px solid var(--border-hi);border-radius:22px;width:100%;max-width:560px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
.modal-inner.wide{max-width:640px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border);background:var(--surface2)}
.modal-title{font-family:'DM Serif Display',Georgia,serif;font-size:20px;color:var(--text)}
.modal-close{background:none;border:none;color:var(--text-muted);font-size:22px;cursor:pointer;line-height:1;padding:4px 8px;border-radius:6px;transition:color .15s,background .15s}
.modal-close:hover{color:var(--text);background:var(--surface3)}
.modal-body{padding:24px;line-height:1.65;font-size:14px;overflow-y:auto;flex:1}
.modal-body ul{margin:10px 0 10px 20px}
.modal-body li{margin:6px 0;font-size:13.5px}
.modal-body p{margin:0 0 12px}
.modal-body p:last-child{margin:0}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);background:var(--surface2)}
.modal-list{padding:16px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:10px}

.history-item{display:flex;gap:14px;padding:14px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);cursor:pointer;transition:border-color .15s,background .15s;align-items:flex-start}
.history-item:hover{border-color:var(--gold);background:var(--surface3)}
.history-meta{font-size:11px;color:var(--text-muted);margin-bottom:4px;display:flex;gap:8px;align-items:center}
.history-preview{font-size:12.5px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.history-title{font-size:14px;font-weight:500;color:var(--text);margin-bottom:3px}
.history-empty{text-align:center;color:var(--text-muted);font-size:13px;padding:40px 20px}
.history-delete{background:none;border:none;color:var(--text-faint);cursor:pointer;font-size:18px;padding:2px 6px;border-radius:4px;margin-left:auto;flex-shrink:0;transition:color .15s}
.history-delete:hover{color:var(--red)}

/* FABRIC TAG */
.fabric-tag{display:inline-block;background:var(--gold-dim);border:1px solid rgba(245,185,68,0.2);color:var(--gold);font-size:11px;padding:2px 8px;border-radius:100px;margin:2px}

/* TOOLTIP */
.product-tag{display:inline-flex;align-items:center;gap:4px;background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:2px 8px;font-size:11px;color:var(--text-muted);margin:2px}

/* CHIPS */
.filter-chip{display:inline-flex;align-items:center;gap:5px;background:var(--gold-dim);border:1px solid rgba(245,185,68,0.25);color:var(--gold);font-size:11px;padding:3px 10px;border-radius:100px;margin:3px 3px 3px 0}
.active-filters{display:flex;flex-wrap:wrap;margin-bottom:10px;min-height:0}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px}
```

  </style>
</head>
<body>
<div class="bg-glow"></div>
<div class="app-wrap">
  <header>
    <div class="header-left">
      <h1 class="header-title">üõãÔ∏è Sofa Advisor</h1>
      <span class="header-badge">Jordan</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost" id="newChatBtn">üÜï New Chat</button>
      <button class="btn btn-ghost" id="historyBtn">üìñ History</button>
      <button class="btn btn-ghost" id="connectAiBtn">ü§ñ Connect AI</button>
      <button class="btn btn-primary" id="clearFiltersBtn">üîÑ Clear Filters</button>
    </div>
  </header>

  <div class="grid-main">
    <!-- FILTERS -->
    <div class="card filters-card">
      <div class="section-title">üîé Refinement Filters</div>
      <div class="active-filters" id="activeFilterChips"></div>
      <div id="filterGroups"></div>
      <div class="filter-status" id="matchCount">Showing all products ‚Ä¢ Ask me anything</div>
    </div>

```
<!-- CHAT -->
<div class="chat-col">
  <div class="chat-card">
    <div class="chat-header">
      <span class="chat-header-label">Sofa Concierge AI</span>
      <div class="live-dot"></div>
    </div>
    <div class="chat-body" id="chatBody">
      <div id="messages"></div>
    </div>
    <div class="chat-input-area">
      <input id="chatInput" type="text" class="chat-input" placeholder="e.g. corner sofa with removable covers under ¬£2000..." autocomplete="off">
      <button class="btn btn-success" id="sendBtn">Send ‚Üµ</button>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- PRODUCT MODAL -->

<div id="productModal" class="modal-overlay">
  <div class="modal-inner wide">
    <div class="modal-header">
      <h2 id="modalProductName" class="modal-title"></h2>
      <button class="modal-close" id="closeModalBtn">√ó</button>
    </div>
    <div id="modalProductBody" class="modal-body"></div>
  </div>
</div>

<!-- HISTORY MODAL -->

<div id="historyModal" class="modal-overlay">
  <div class="modal-inner">
    <div class="modal-header">
      <h2 class="modal-title">üìñ Conversation History</h2>
      <button class="modal-close" id="closeHistoryBtn">√ó</button>
    </div>
    <div id="historyList" class="modal-list"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost full-width" id="closeHistoryFooterBtn">Close</button>
    </div>
  </div>
</div>

<script>
/* ‚îÄ‚îÄ‚îÄ CATALOG (real sofa.com data) ‚îÄ‚îÄ‚îÄ */
const catalog = {
  products: [
    {"name":"Slim Marco Sofa","category":"Sofa","subcategory":"Spring/Summer 2026","starting_price":"From ¬£1,420","url":"https://www.sofa.com/gb/spring-summer-2026/slim-marco-sofa/p/SO-SMR","description":"Slim profile contemporary sofa from the Spring/Summer 2026 collection. 100+ fabrics and custom sizes available.","key_features":["Slim profile","Custom sizes","Bespoke fabric choice","New for 2026"]},
    {"name":"Bluebell Sofa","category":"Sofa","subcategory":"Bespoke / Classic","starting_price":"From ¬£1,180","url":"https://www.sofa.com/gb/bespoke-sofas/bluebell-sofa/p/SO-BLU","description":"Classic pleated arm sofa with turned oak legs and bronze castors. Feather-wrapped foam seat cushions, feather & fibre back. Breakdownable option available.","key_features":["Pleated scrolled arms","Removable cushion covers","Sweetheart frame","Breakdownable for narrow hallways (+¬£280)"],"variants":["2 Seat (W164cm)","2.5 Seat (W192cm)","3 Seat (W218cm)","4 Seat (W244cm)"]},
    {"name":"Isla Sofa","category":"Sofa","subcategory":"Removable Covers","starting_price":"From ¬£1,230","url":"https://www.sofa.com/gb/bespoke-sofas/sofas-with-removable-covers/isla-sofa/p/SO-ISL","description":"Contemporary sofa with fully removable and washable covers ‚Äî perfect for families and busy homes. 100+ fabrics available.","key_features":["Fully removable covers","Machine washable","100+ fabric options","Family-friendly"]},
    {"name":"Teddy Sofa","category":"Sofa","starting_price":"From ¬£1,580","url":"https://www.sofa.com/gb/bespoke-sofas/teddy-sofa/p/SO-TED","description":"Plush, generously proportioned sofa with deep cushioning. Available in 100+ fabrics including boucle and velvet.","key_features":["Deep cushioning","100+ fabrics","Bespoke handmade","Multiple sizes"]},
    {"name":"Izzy Sofa","category":"Sofa","subcategory":"Bestselling","starting_price":"From ¬£1,180","url":"https://www.sofa.com/gb/bespoke-sofas/bestselling-sofas/izzy-sofa/p/SO-IZZ","description":"One of sofa.com's bestselling sofas ‚Äî a modern classic with clean lines and exceptional comfort. Available in 100+ fabrics.","key_features":["Bestselling model","Clean contemporary lines","100+ fabrics","Multiple size options"]},
    {"name":"Aissa Sofa Bed","category":"Sofa Bed","starting_price":"Was From ¬£2,150 Now From ¬£1,505","url":"https://www.sofa.com/gb/beds/aissa-sofa-bed/p/SB-AIS","description":"Stylish sofa bed with a smooth fold-out mechanism. Currently on sale. Available in multiple seat sizes and 100+ fabrics.","key_features":["Smooth fold-out mechanism","Currently on sale ‚Äî save ¬£645","100+ fabrics","Multiple seat sizes"]},
    {"name":"Isla Corner Sofa","category":"Corner Sofa","starting_price":"From ¬£2,180","url":"https://www.sofa.com/gb/bespoke-sofas/isla-corner-sofa/p/CS-ISL","description":"The Isla in a generous corner configuration. Removable covers, contemporary styling, and 100+ fabric options.","key_features":["Corner configuration","Removable covers","Contemporary design","LHF and RHF options"]},
    {"name":"Bluebell Sofa Bed","category":"Sofa Bed","starting_price":"From ¬£1,400","url":"https://www.sofa.com/gb/beds/bluebell-sofa-bed/p/SB-BLB","description":"The classic Bluebell collection reimagined as a sofa bed. Pleated scrolled arms with fold-out bed mechanism.","key_features":["Classic Bluebell styling","Fold-out bed","Pleated scrolled arms","2, 2.5, 3 Seat variants"],"variants":["2 Seat","Loveseat","2.5 Seat","3 Seat"]},
    {"name":"Patrick Sofa","category":"Sofa","starting_price":"From ¬£1,310","url":"https://www.sofa.com/gb/bespoke-sofas/patrick-sofa/p/SO-PTR","description":"A refined bespoke sofa with classic proportions and handmade quality. Available in 100+ fabrics.","key_features":["Handmade bespoke","Classic proportions","100+ fabrics","Lifetime frame guarantee"]},
    {"name":"Otto Sofa","category":"Sofa","subcategory":"Removable Covers","starting_price":"From ¬£1,310","url":"https://www.sofa.com/gb/bespoke-sofas/sofas-with-removable-covers/otto-sofa/p/SO-OTO","description":"A stylish sofa with practical removable and washable covers. Great for families, pets and busy homes.","key_features":["Removable machine-washable covers","Family and pet friendly","100+ fabrics","Contemporary styling"]},
    {"name":"Costello Sofa","category":"Sofa","subcategory":"Classic Traditional","starting_price":"From ¬£1,480","url":"https://www.sofa.com/gb/bespoke-sofas/classic-traditional-sofas/costello-sofa/p/SO-CSP","description":"A classic British traditional sofa with high-back comfort and traditional craftsmanship. Available in weaves, velvets and more.","key_features":["Classic traditional styling","High-back comfort","Coil-sprung construction","100+ fabrics"]},
    {"name":"Long Island Modular Sofa","category":"Modular Sofa / Corner","starting_price":"From ¬£640","url":"https://www.sofa.com/gb/bespoke-sofas/corner-sofas/long-island-modular-sofa/p/CS-LON","description":"Flexible modular corner sofa system ‚Äî buy sections individually and build your ideal configuration. 100+ fabrics.","key_features":["Fully modular system","Buy sections individually","Build any configuration","100+ fabrics"]},
    {"name":"Anders Sofa","category":"Sofa","starting_price":"Was From ¬£1,850 Now From ¬£1,295","url":"https://www.sofa.com/gb/bespoke-sofas/anders-sofa/p/FS-AND","description":"Contemporary sofa currently on sale. Clean lines and bespoke quality at a reduced price.","key_features":["Currently on sale ‚Äî save ¬£555","Contemporary design","Bespoke handmade","100+ fabrics"]},
    {"name":"Ren Chaise Sofa","category":"Chaise Sofa","starting_price":"Was From ¬£2,080 Now From ¬£1,456","url":"https://www.sofa.com/gb/bespoke-sofas/ren-chaise-sofa/p/CH-REN","description":"Elegant chaise sofa with extended lounging section. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£624","Chaise lounging section","LHF and RHF options","100+ fabrics"]},
    {"name":"Malibu Sofa","category":"Sofa","starting_price":"Was From ¬£2,380 Now From ¬£1,666","url":"https://www.sofa.com/gb/bespoke-sofas/malibu-sofa/p/FS-MBU","description":"Premium sofa with a luxurious California-inspired silhouette. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£714","Luxurious wide proportions","Premium materials","100+ fabrics"]},
    {"name":"Teddy Chaise","category":"Chaise Sofa","starting_price":"Was From ¬£3,260 Now From ¬£2,282","url":"https://www.sofa.com/gb/bespoke-sofas/chaise-lounge-sofas/teddy-chaise/p/CH-TED","description":"The plush Teddy collection in a generous chaise configuration. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£978","Plush deep cushioning","Chaise configuration","100+ fabrics"]},
    {"name":"Sloane Modular Sofa","category":"Modular Sofa","starting_price":"Was From ¬£955 Now From ¬£668.50","url":"https://www.sofa.com/gb/bespoke-sofas/sloane-modular-sofa/p/FM-SLO","description":"Affordable modular sofa with flexible configuration options. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£286.50","Modular flexible system","Excellent value","100+ fabrics"]},
    {"name":"Costello Open End Chaise Sofa","category":"Chaise Sofa","starting_price":"Was From ¬£4,210 Now From ¬£2,947","url":"https://www.sofa.com/gb/bespoke-sofas/costello-open-end-chaise-sofa/p/CH-CSP","description":"Generous traditional chaise sofa in the classic Costello style. Open-end design. Currently on sale.","key_features":["Traditional Costello styling","Open-end chaise","On sale ‚Äî save ¬£1,263","100+ fabrics"]},
    {"name":"Iggy Sofa","category":"Sofa","subcategory":"Bestselling","starting_price":"From ¬£1,180","url":"https://www.sofa.com/gb/bespoke-sofas/bestselling-sofas/iggy-sofa/p/SO-IGG","description":"A sofa.com bestseller with a modern, accessible design and exceptional comfort. Available in 100+ fabrics.","key_features":["Bestselling sofa","Modern accessible design","100+ fabrics","Multiple sizes"]},
    {"name":"Long Island Slim Sofa Bed","category":"Sofa Bed","starting_price":"From ¬£2,150","url":"https://www.sofa.com/gb/beds/long-island-slim-sofa-bed/p/SB-SLN","description":"Slim-profile sofa bed from the Long Island modular range. Ideal for smaller rooms. 100+ fabrics.","key_features":["Slim profile design","Fold-out bed mechanism","Modular range","100+ fabrics"]},
    {"name":"Malibu Corner Sofa","category":"Corner Sofa","starting_price":"Was From ¬£5,610 Now From ¬£3,927","url":"https://www.sofa.com/gb/bespoke-sofas/malibu-corner-sofa/p/FM-MBU","description":"Premium large corner sofa in the Malibu collection. Major sale saving. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£1,683","Premium corner configuration","Large generous proportions","100+ fabrics"]},
    {"name":"Malibu Chaise Sofa","category":"Chaise Sofa","starting_price":"Was From ¬£3,850 Now From ¬£2,695","url":"https://www.sofa.com/gb/bespoke-sofas/chaise-lounge-sofas/malibu-chaise-sofa/p/FC-MBU","description":"Luxurious chaise sofa from the premium Malibu collection. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£1,155","Premium Malibu collection","Chaise configuration","LHF and RHF options"]},
    {"name":"Marco Sofa","category":"Sofa","starting_price":"Was From ¬£2,090 Now From ¬£1,463","url":"https://www.sofa.com/gb/bespoke-sofas/marco-sofa/p/FS-MRC","description":"Contemporary sofa with a refined profile. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£627","Refined contemporary profile","Bespoke handmade","100+ fabrics"]},
    {"name":"Iggy High Back Seat Sofa","category":"Sofa","starting_price":"Was From ¬£2,160 Now From ¬£1,512","url":"https://www.sofa.com/gb/bespoke-sofas/iggy-high-back-seat-sofa/p/FS-HIG","description":"The bestselling Iggy in a high-back configuration for extra head and neck support. Currently on sale.","key_features":["On sale ‚Äî save ¬£648","High-back for extra support","Based on bestselling Iggy","100+ fabrics"]},
    {"name":"Marco Corner Sofa","category":"Corner Sofa","starting_price":"Was From ¬£4,770 Now From ¬£3,339","url":"https://www.sofa.com/gb/bespoke-sofas/marco-corner-sofa/p/CS-MRC","description":"The Marco collection in a generous corner format. Major sale saving. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£1,431","Corner configuration","Contemporary Marco styling","100+ fabrics"]},
    {"name":"Holly Sofa","category":"Sofa","subcategory":"Mid-Century","starting_price":"From ¬£900","url":"https://www.sofa.com/gb/bespoke-sofas/mid-century/holly-sofa/p/SO-HOL","description":"An elegant mid-century inspired sofa with clean geometric lines and tapered legs. Excellent entry price.","key_features":["Mid-century design","Tapered legs","Great entry price","100+ fabrics"]},
    {"name":"Marco Chaise Sofa","category":"Chaise Sofa","starting_price":"Was From ¬£3,280 Now From ¬£2,296","url":"https://www.sofa.com/gb/bespoke-sofas/chaise-lounge-sofas/marco-chaise-sofa/p/FM-MRC","description":"The Marco collection in a chaise configuration. Currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£984","Chaise configuration","Contemporary Marco styling","LHF and RHF options"]},
    {"name":"Lars Sofa","category":"Sofa","starting_price":"From ¬£1,360","url":"https://www.sofa.com/gb/bespoke-sofas/lars-sofa/p/FS-LAR","description":"A sleek Scandinavian-influenced sofa with clean lines and a relaxed profile. 100+ fabrics.","key_features":["Scandinavian-influenced design","Clean lines","Relaxed profile","100+ fabrics"]},
    {"name":"High Back Iggy 2 Seat Recliner Sofa","category":"Recliner Sofa","starting_price":"From ¬£2,240","url":"https://www.sofa.com/gb/bespoke-sofas/high-back-iggy-2-seat-recliner-sofa/p/RS-HIG","description":"The Iggy in a high-back recliner configuration. Smooth reclining mechanism with lumbar support.","key_features":["High-back recliner","Smooth reclining mechanism","Lumbar support","Based on bestselling Iggy design"]},
    {"name":"Lars Corner Sofa","category":"Corner Sofa","starting_price":"From ¬£2,290","url":"https://www.sofa.com/gb/bespoke-sofas/lars-corner-sofa/p/CS-LAR","description":"The Scandinavian-influenced Lars in a corner configuration. 100+ fabrics.","key_features":["Corner configuration","Scandinavian design","LHF and RHF options","100+ fabrics"]},
    {"name":"Aissa Corner Sofa Bed","category":"Corner Sofa Bed","starting_price":"From ¬£2,950","url":"https://www.sofa.com/gb/bespoke-sofas/aissa-corner-sofa-bed/p/CB-AIS","description":"A corner sofa that converts to a bed ‚Äî ideal for guest rooms. LHF/RHF variants. 100+ fabrics.","key_features":["Corner + sofa bed in one","LHF and RHF options","100+ fabrics","Guest room solution"]},
    {"name":"Aissa Chaise Sofa Bed","category":"Chaise Sofa Bed","starting_price":"From ¬£2,330","url":"https://www.sofa.com/gb/bespoke-sofas/aissa-chaise-sofa-bed/p/HB-AIS","description":"Chaise sofa with fold-out bed mechanism. Storage options available in some configurations. 100+ fabrics.","key_features":["Chaise + sofa bed","Storage options in some configs","100+ fabrics","LHF and RHF options"]},
    {"name":"Jack in a Box Bed","category":"Sofa Bed","starting_price":"From ¬£890","url":"https://www.sofa.com/gb/beds/jack-in-a-box-bed/p/BX-JIB","description":"A clever compact sofa bed with a simple unfold mechanism. Great value entry point. 100+ fabrics.","key_features":["Compact clever design","Simple unfold mechanism","Best value sofa bed","100+ fabrics"]},
    {"name":"Henry Bed In Box","category":"Sofa Bed","starting_price":"Was From ¬£1,290 Now From ¬£903","url":"https://www.sofa.com/gb/beds/henry-bed-in-box/p/BX-HNR","description":"A space-saving bed-in-a-box sofa bed currently on sale. 100+ fabrics.","key_features":["On sale ‚Äî save ¬£387","Space-saving design","Compact fold-out","100+ fabrics"]}
  ],
  fabrics: {
    total: "Over 100 (up to 160 options)",
    origin: "Premium natural materials woven in the finest mills in Belgium and Italy",
    full_list: ["Antique Leather","Aquaclean Clever Canvas","Aquaclean Clever Chenille","Aquaclean Clever Velvet","Aquaclean Linen Look","Baylee Multi-Tone Viscose Linen","Baylee Viscose Linen","Brushed Linen Cotton","Brushstroke","Bubble Velvet","Cashmere Velvet","Chinoiserie","Cotton Matt Velvet","Cove","Cross Weave","Dashwood Stripe","Easy Cotton","Faux Leather","Florence Textured Weave","Grain Leather","Heathland Weave","House Basket Weave","House Herringbone Weave","House Soft Touch","House Stripe","House Velvet","Hygge Chunky Weave","Hygge Smart Linen","Linen","Norfolk Cotton","Norfolk Spring","Organic Smart Cotton","Pure Cotton Matt Velvet","Shoreline","Silky Jacquard Weave","Smart Slubby Cotton","Smart Velvet","Soft Weave","Velvet"],
    highlighted_collections_and_details: [
      {group:"Smart / Performance",examples:["Smart Velvet: spill-resistant, silky soft, >75% cotton, family-friendly","Easy Cotton: machine-washable, 100% cotton","Aquaclean Clever series (Canvas, Chenille, Velvet, Linen Look): cleanability technology built in"]},
      {group:"House Collection (Italy)",examples:["House Herringbone Weave: thicker fibre, highly durable, 100% cotton","House Basket Weave, House Stripe, House Soft Touch, House Velvet"]},
      {group:"Velvets & Plush",examples:["Pure Cotton Matt Velvet: 100% cotton, deep luxurious pile","Luxe Boucle: super-soft twisted wool fibres, ultra-durable, Scandi texture","Cashmere Velvet: premium softness","Bubble Velvet: textured tactile finish"]},
      {group:"Linens & Naturals",examples:["Vermeer Linen: 100% linen from flax, rustic sustainable charm","Baylee Viscose Linen: subtle basket weave, 15% recycled cotton","Brushed Linen Cotton: soft and relaxed feel"]},
      {group:"Leathers & Others",examples:["Antique Leather: classic aged character","Grain Leather: smooth structured look","Faux Leather: easy-clean vegan option","Heathland Weave: earthy textured luxury"]}
    ]
  }
};

/* ‚îÄ‚îÄ‚îÄ ENRICH CATALOG with parsed prices ‚îÄ‚îÄ‚îÄ */
function parsePrice(str) {
  if (!str) return null;
  const nowMatch = str.match(/Now\s*From\s*¬£([\d,]+\.?\d*)/i);
  if (nowMatch) return parseFloat(nowMatch[1].replace(/,/g,''));
  const fromMatch = str.match(/From\s*¬£([\d,]+\.?\d*)/i);
  if (fromMatch) return parseFloat(fromMatch[1].replace(/,/g,''));
  return null;
}

catalog.products.forEach(p => {
  p.price_num = parsePrice(p.starting_price);
  p.on_sale = /now from/i.test(p.starting_price);
  if (p.on_sale) {
    const wasMatch = p.starting_price.match(/Was\s*From\s*¬£([\d,]+\.?\d*)/i);
    if (wasMatch) p.was_price = parseFloat(wasMatch[1].replace(/,/g,''));
  }
});

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let activeFilters = {}; // {groupTitle: Set of selected options}
let groqApiKey = localStorage.getItem('groqApiKey') || '';
let messages = [];
let chatHistory = []; // for Groq API turns
let conversations = [];
let currentConversationId = null;

/* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function getToday() { return new Date().toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}); }
function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

/* ‚îÄ‚îÄ‚îÄ FILTER STRUCTURE ‚îÄ‚îÄ‚îÄ */
const filterStructure = [
  {title:"Sofa Types", options:["Sofa","Sofa Bed","Corner Sofa","Chaise Sofa","Modular Sofa / Corner","Recliner Sofa","Corner Sofa Bed","Chaise Sofa Bed"]},
  {title:"Styles & Features", options:["Bestselling","Removable Covers","Mid-Century","Spring/Summer 2026","Classic Traditional","Bespoke / Classic"]},
  {title:"Deals", options:["On Sale"]}
];

// Init filter state
filterStructure.forEach(g => { activeFilters[g.title] = new Set(); });

function renderFilters() {
  const container = document.getElementById('filterGroups');
  container.innerHTML = '';
  filterStructure.forEach(group => {
    const div = document.createElement('div');
    div.className = 'filter-group';
    const h3 = document.createElement('h3');
    h3.textContent = group.title;
    div.appendChild(h3);
    group.options.forEach(opt => {
      const label = document.createElement('label');
      label.className = 'filter-option';
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.dataset.filter = opt;
      chk.dataset.group = group.title;
      chk.addEventListener('change', () => {
        if (chk.checked) activeFilters[group.title].add(opt);
        else activeFilters[group.title].delete(opt);
        updateMatchCount();
        updateFilterChips();
      });
      label.appendChild(chk);
      label.appendChild(document.createTextNode(' ' + opt));
      div.appendChild(label);
    });
    container.appendChild(div);
  });
  updateMatchCount();
}

function updateFilterChips() {
  const container = document.getElementById('activeFilterChips');
  container.innerHTML = '';
  filterStructure.forEach(g => {
    activeFilters[g.title].forEach(f => {
      const chip = document.createElement('span');
      chip.className = 'filter-chip';
      chip.textContent = f;
      container.appendChild(chip);
    });
  });
}

function getActiveFiltersFlat() {
  const all = [];
  filterStructure.forEach(g => activeFilters[g.title].forEach(f => all.push({group: g.title, val: f})));
  return all;
}

function updateMatchCount() {
  const count = getActiveProducts().length;
  const flat = getActiveFiltersFlat();
  const el = document.getElementById('matchCount');
  el.textContent = flat.length > 0
    ? `${count} product${count!==1?'s':''} match your filters`
    : `Showing all ${count} products ‚Ä¢ Ask me anything`;
}

function clearAllFilters() {
  filterStructure.forEach(g => activeFilters[g.title].clear());
  document.querySelectorAll('#filterGroups input[type="checkbox"]').forEach(c => c.checked = false);
  updateMatchCount();
  updateFilterChips();
  addMessage('bot', '‚úÖ All filters cleared. Showing full catalog of ' + catalog.products.length + ' sofas.', true, false);
}

function getActiveProducts() {
  const flat = getActiveFiltersFlat();
  if (flat.length === 0) return catalog.products;

  // Group filters by group title ‚Äî within a group it's OR, across groups it's AND
  return catalog.products.filter(p => {
    return filterStructure.every(group => {
      const selected = activeFilters[group.title];
      if (selected.size === 0) return true; // no filter in this group = pass
      // Check if product matches ANY option in this group
      return [...selected].some(f => {
        if (f === 'On Sale') return p.on_sale;
        const text = `${p.category||''} ${p.subcategory||''} ${p.name||''}`.toLowerCase();
        return text.includes(f.toLowerCase());
      });
    });
  });
}

/* ‚îÄ‚îÄ‚îÄ PRODUCT CARD ‚îÄ‚îÄ‚îÄ */
function productCard(p) {
  const idx = catalog.products.indexOf(p);
  const saleTag = p.on_sale ? `<span style="background:var(--green);color:#0f0f10;font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;margin-left:6px">SALE</span>` : '';
  let priceHtml = '';
  if (p.on_sale && p.was_price && p.price_num) {
    priceHtml = `<span style="text-decoration:line-through;opacity:.5;font-size:12px">From ¬£${p.was_price.toLocaleString()}</span> <span style="color:var(--green)">Now ¬£${p.price_num.toLocaleString()}</span>`;
  } else {
    priceHtml = `<span style="color:var(--gold)">${escHtml(p.starting_price)}</span>`;
  }
  return `<div class="mini-product" data-index="${idx}">
    <strong>${escHtml(p.name)}${saleTag}</strong>
    <div class="price" style="margin:3px 0;font-size:13px">${priceHtml}</div>
    <small>${escHtml((p.description||'Bespoke handmade sofa').substring(0,120))}‚Ä¶</small>
  </div>`;
}

/* ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ */
function addMessage(role, html, save=true, isAI=false) {
  messages.push({role, content: html, time: Date.now(), isAI});
  if (save) saveCurrentConversation();
  renderMessages();
}

function renderMessages() {
  const cont = document.getElementById('messages');
  cont.innerHTML = messages.map(msg => `
    <div class="message ${msg.role}">
      <div class="avatar">${msg.role==='bot'?'üõãÔ∏è':'J'}</div>
      <div class="bubble">${msg.content}</div>
    </div>
  `).join('');
  const body = document.getElementById('chatBody');
  body.scrollTop = body.scrollHeight;
}

function showTyping() {
  const cont = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'message bot';
  div.id = 'typingIndicator';
  div.innerHTML = `<div class="avatar">üõãÔ∏è</div><div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
  cont.appendChild(div);
  document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight;
}

function removeTyping() {
  const t = document.getElementById('typingIndicator');
  if (t) t.remove();
}

/* ‚îÄ‚îÄ‚îÄ GROQ AI ‚îÄ‚îÄ‚îÄ */
function buildSystemPrompt() {
  const activeProds = getActiveProducts();
  const flat = getActiveFiltersFlat();
  const filterDesc = flat.length > 0 ? `Active filters: ${flat.map(f=>f.val).join(', ')}. ` : '';

  const prodList = activeProds.map(p => {
    let price = p.on_sale && p.price_num ? `Now ¬£${p.price_num.toLocaleString()} (was ¬£${p.was_price?.toLocaleString()}) ON SALE` : p.starting_price;
    return `- ${p.name} | ${p.category}${p.subcategory?' / '+p.subcategory:''} | ${price} | ${p.description||''}${p.key_features?.length?' | Features: '+p.key_features.join('; '):''}`;
  }).join('\n');

  const fabricList = catalog.fabrics.highlighted_collections_and_details.map(g =>
    `${g.group}: ${g.examples.join(', ')}`
  ).join('\n');

  return `You are a friendly, knowledgeable sofa advisor for sofa.com. You help customers find their perfect sofa from the real catalog below.

${filterDesc}You have ${activeProds.length} products currently visible (${catalog.products.length} total).

CATALOG (currently shown):
${prodList}

FABRICS (100+ available, free swatches up to 6):
${fabricList}

KEY FACTS:
- All sofas are bespoke handmade in the UK
- Lifetime frame guarantee on all models
- White-glove delivery ~¬£149 UK mainland, 4-6 weeks typical lead time
- Customer's Own Material (COM) accepted
- Breakdown options available on some models for narrow hallways

INSTRUCTIONS:
- Be conversational, warm, and concise. Don't be robotic.
- When recommending specific products, end your message with a special tag listing them like: <!--PRODUCTS:Bluebell Sofa,Isla Sofa-->
- Only recommend products that are in the current catalog list above.
- For budget queries, only recommend products within budget.
- When filters are active, only recommend products from the filtered list.
- Format responses with simple HTML: <p>, <strong>, <em>, <ul>, <li> tags only. No markdown.
- Keep responses focused and not too long.`;
}

async function callGroq(userMessage) {
  if (!groqApiKey) {
    showApiKeyPrompt();
    return null;
  }

  chatHistory.push({ role: 'user', content: userMessage });

  const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${groqApiKey}`
    },
    body: JSON.stringify({
      model: 'llama-3.3-70b-versatile',
      messages: [
        { role: 'system', content: buildSystemPrompt() },
        ...chatHistory
      ],
      temperature: 0.7,
      max_tokens: 1024
    })
  });

  if (!response.ok) {
    const err = await response.json().catch(()=>({error:{message:'Unknown error'}}));
    if (response.status === 401) {
      groqApiKey = '';
      localStorage.removeItem('groqApiKey');
      showApiKeyPrompt();
      return null;
    }
    throw new Error(err.error?.message || `HTTP ${response.status}`);
  }

  const data = await response.json();
  const text = data.choices[0].message.content;
  chatHistory.push({ role: 'assistant', content: text });
  return text;
}

function parseAIResponse(rawText) {
  // Extract product recommendations from <!--PRODUCTS:...--> tag
  const prodMatch = rawText.match(/<!--PRODUCTS:(.*?)-->/);
  let productNames = [];
  if (prodMatch) {
    productNames = prodMatch[1].split(',').map(s => s.trim());
    rawText = rawText.replace(/<!--PRODUCTS:.*?-->/g, '');
  }

  let html = rawText.trim();

  // Append product cards for any named products
  if (productNames.length > 0) {
    productNames.forEach(name => {
      const p = catalog.products.find(p => p.name.toLowerCase() === name.toLowerCase());
      if (p) html += productCard(p);
    });
  }

  return html;
}

/* ‚îÄ‚îÄ‚îÄ API KEY MODAL ‚îÄ‚îÄ‚îÄ */
function showApiKeyPrompt() {
  document.getElementById('apiKeyModal').classList.add('open');
  document.getElementById('apiKeyInput').value = groqApiKey || '';
  document.getElementById('apiKeyInput').focus();
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) return;
  groqApiKey = key;
  localStorage.setItem('groqApiKey', key);
  document.getElementById('apiKeyModal').classList.remove('open');
  addMessage('bot', '‚úÖ Groq API key saved! I\'m now powered by <strong>Llama 3.3 70B</strong> via Groq. Ask me anything about sofas!', true, false);
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  input.disabled = true;
  document.getElementById('sendBtn').disabled = true;

  addMessage('user', escHtml(text), true, false);
  showTyping();

  try {
    const rawResponse = await callGroq(text);
    removeTyping();
    if (rawResponse) {
      const html = parseAIResponse(rawResponse);
      addMessage('bot', html, true, true);
    }
  } catch(err) {
    removeTyping();
    addMessage('bot', `<p>‚ö†Ô∏è Error: ${escHtml(err.message)}</p><p>Check your Groq API key or try again.</p>`, true, false);
  }

  input.disabled = false;
  document.getElementById('sendBtn').disabled = false;
  input.focus();
}

/* ‚îÄ‚îÄ‚îÄ PRODUCT MODAL ‚îÄ‚îÄ‚îÄ */
function showProductByIndex(idx) {
  const p = catalog.products[idx];
  if (!p) return;
  document.getElementById('modalProductName').textContent = p.name;

  let priceDisplay = '';
  if (p.on_sale && p.was_price && p.price_num) {
    priceDisplay = `<span style="text-decoration:line-through;opacity:.5;font-size:16px;margin-right:10px">¬£${p.was_price.toLocaleString()}</span><span style="color:var(--green);font-size:24px">Now ¬£${p.price_num.toLocaleString()}</span><span style="background:var(--green);color:#0f0f10;font-size:11px;font-weight:700;padding:3px 9px;border-radius:100px;margin-left:10px;vertical-align:middle">SALE</span>`;
  } else {
    priceDisplay = `<span style="color:var(--gold);font-size:24px">${escHtml(p.starting_price)}</span>`;
  }

  let body = `
    <p style="margin:0 0 14px;font-family:'DM Serif Display',serif">${priceDisplay}</p>
    <p>${escHtml(p.description||'Handmade bespoke sofa. Available in 100+ fabrics.')}</p>
    <div style="height:1px;background:var(--border);margin:16px 0"></div>
  `;
  if (p.key_features?.length) {
    body += `<p><strong>Key Features</strong></p><ul>`;
    p.key_features.forEach(f => body += `<li>${escHtml(f)}</li>`);
    body += `</ul>`;
  }
  if (p.variants?.length) {
    body += `<p style="margin-top:14px"><strong>Available Configurations:</strong></p><p>`;
    p.variants.forEach(v => body += `<span class="product-tag">${escHtml(v)}</span>`);
    body += `</p>`;
  }
  if (p.url) {
    body += `<div style="margin-top:18px"><a href="${escHtml(p.url)}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:var(--gold);color:#0f0f10;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:600;font-size:13px">View on sofa.com ‚Üó</a></div>`;
  }
  body += `<div style="height:1px;background:var(--border);margin:16px 0"></div>
    <p style="font-size:12px;color:var(--text-muted)">‚úÖ Lifetime frame guarantee &nbsp;‚Ä¢&nbsp; üöö White-glove delivery (~¬£149) &nbsp;‚Ä¢&nbsp; üé® Free swatches (up to 6) &nbsp;‚Ä¢&nbsp; ‚è± 4‚Äì6 weeks typical lead time</p>`;
  document.getElementById('modalProductBody').innerHTML = body;
  document.getElementById('productModal').classList.add('open');
}

/* ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ */
function saveCurrentConversation() {
  if (!currentConversationId) currentConversationId = generateId();
  const existing = conversations.findIndex(c => c.id === currentConversationId);
  const conv = {
    id: currentConversationId,
    date: getToday(),
    messages: [...messages],
    preview: messages.find(m=>m.role==='user')?.content || 'New conversation'
  };
  if (existing >= 0) conversations[existing] = conv;
  else conversations.unshift(conv);
  try { localStorage.setItem('sofaAdvisorHistory', JSON.stringify(conversations)); } catch(e){}
}

function loadConversations() {
  try {
    const saved = localStorage.getItem('sofaAdvisorHistory');
    if (saved) conversations = JSON.parse(saved);
  } catch(e) { conversations = []; }
}

function renderHistoryList() {
  const list = document.getElementById('historyList');
  if (conversations.length === 0) {
    list.innerHTML = `<div class="history-empty">No conversations yet.<br><span style="font-size:12px">Start chatting to build your history.</span></div>`;
    return;
  }
  list.innerHTML = '';
  conversations.forEach(conv => {
    const item = document.createElement('div');
    item.className = 'history-item';
    const firstUserMsg = conv.messages.find(m=>m.role==='user');
    const preview = firstUserMsg ? firstUserMsg.content : 'New conversation';
    item.innerHTML = `
      <div style="flex:1;min-width:0">
        <div class="history-meta"><span>üìÖ ${conv.date}</span><span>${conv.messages.length} messages</span></div>
        <div class="history-title">Conversation</div>
        <div class="history-preview">${escHtml(preview).substring(0,80)}</div>
      </div>
      <button class="history-delete" data-id="${conv.id}" title="Delete">üóë</button>
    `;
    item.addEventListener('click', e => {
      if (e.target.closest('.history-delete')) return;
      loadConversation(conv.id);
    });
    item.querySelector('.history-delete').addEventListener('click', e => {
      e.stopPropagation();
      deleteConversation(conv.id);
    });
    list.appendChild(item);
  });
}

function loadConversation(id) {
  const conv = conversations.find(c => c.id === id);
  if (!conv) return;
  currentConversationId = id;
  messages = [...conv.messages];
  chatHistory = [];
  renderMessages();
  closeHistory();
  addMessage('bot', `üìÇ Conversation restored ‚Äî ${conv.messages.length} messages loaded.`, false, false);
}

function deleteConversation(id) {
  conversations = conversations.filter(c => c.id !== id);
  try { localStorage.setItem('sofaAdvisorHistory', JSON.stringify(conversations)); } catch(e){}
  renderHistoryList();
}

function showHistory() {
  renderHistoryList();
  document.getElementById('historyModal').classList.add('open');
}

function closeHistory() {
  document.getElementById('historyModal').classList.remove('open');
}

function newConversation() {
  if (messages.length > 1) saveCurrentConversation();
  currentConversationId = generateId();
  messages = [];
  chatHistory = [];
  addMessage('bot', 'New conversation started! üõãÔ∏è<br><br>How can I help you find your perfect sofa?', false, false);
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
window.onload = function() {
  renderFilters();
  loadConversations();

  // Event listeners
  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(); });
  document.getElementById('newChatBtn').addEventListener('click', newConversation);
  document.getElementById('historyBtn').addEventListener('click', showHistory);
  document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
  document.getElementById('closeModalBtn').addEventListener('click', () => document.getElementById('productModal').classList.remove('open'));
  document.getElementById('productModal').addEventListener('click', e => { if (e.target.id === 'productModal') e.target.classList.remove('open'); });
  document.getElementById('closeHistoryBtn').addEventListener('click', closeHistory);
  document.getElementById('closeHistoryFooterBtn').addEventListener('click', closeHistory);
  document.getElementById('historyModal').addEventListener('click', e => { if (e.target.id === 'historyModal') closeHistory(); });

  // Product card click delegation
  document.getElementById('messages').addEventListener('click', e => {
    const card = e.target.closest('.mini-product');
    if (card) {
      const idx = parseInt(card.dataset.index, 10);
      if (!isNaN(idx)) showProductByIndex(idx);
    }
  });

  document.getElementById('closeApiKeyBtn').addEventListener('click', () => document.getElementById('apiKeyModal').classList.remove('open'));
  document.getElementById('apiKeyModal').addEventListener('click', e => { if (e.target.id === 'apiKeyModal') e.target.classList.remove('open'); });
  document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
  document.getElementById('apiKeyInput').addEventListener('keypress', e => { if (e.key === 'Enter') saveApiKey(); });
  document.getElementById('connectAiBtn').addEventListener('click', showApiKeyPrompt);

  // Welcome
  currentConversationId = generateId();
  const saleCount = catalog.products.filter(p=>p.on_sale).length;
  const aiStatus = groqApiKey ? `I'm powered by <strong>Llama 3.3 70B via Groq</strong> ‚Äî real AI responses.` : `Click <strong>ü§ñ Connect AI</strong> to enable Groq AI, or I'll use basic keyword matching.`;
  addMessage('bot', `Hi Jordan üëã I'm your <strong>Sofa Concierge</strong>.<br><br>I have <strong>${catalog.products.length} real sofa.com products</strong> loaded ‚Äî ${saleCount} currently on sale. ${aiStatus}<br><br>Try: <em>"corner sofa under ¬£2500"</em>, <em>"show me sale items"</em>, or <em>"I need a sofa bed for guests"</em>.`, false, false);

  document.getElementById('chatInput').focus();

  // Show API key prompt if no key saved
  if (!groqApiKey) {
    setTimeout(() => showApiKeyPrompt(), 800);
  }
};
</script>

<!-- API KEY MODAL -->

<div id="apiKeyModal" class="modal-overlay">
  <div class="modal-inner" style="max-width:460px">
    <div class="modal-header">
      <h2 class="modal-title">ü§ñ Connect Groq AI</h2>
      <button class="modal-close" id="closeApiKeyBtn">√ó</button>
    </div>
    <div class="modal-body">
      <p>Enable real AI responses powered by <strong>Llama 3.3 70B</strong> (free, very fast).</p>
      <p style="margin-top:8px;font-size:12px;color:var(--text-muted)">Get a free key at <a href="https://console.groq.com" target="_blank" style="color:var(--gold)">console.groq.com</a> ‚Äî takes 30 seconds.</p>
      <div style="margin-top:18px">
        <input id="apiKeyInput" type="password" placeholder="gsk_..." 
          style="width:100%;background:var(--surface3);border:1px solid var(--border-hi);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;padding:12px 14px;outline:none;margin-bottom:12px;box-sizing:border-box"
          autocomplete="off">
        <button class="btn btn-success full-width" id="saveApiKeyBtn">Save & Enable AI ‚úì</button>
      </div>
      <p style="margin-top:14px;font-size:11px;color:var(--text-faint)">Stored only in your browser's localStorage ‚Äî never sent anywhere except Groq's API.</p>
    </div>
  </div>
</div>

</body>
</html>
